---
pagetitle: "Key climate & ocean drivers"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=F}
knitr::opts_chunk$set(echo = F, message = F, warning = F)
```

```{r}
source(here::here("scripts/oceano.R"))
source(here::here("scripts/utility.R"))

nms       <- "cinms"
sites_csv <- here("data/nms_sites.csv")

nms_ply <- get_nms_ply(nms)

if (F){
  st_centroid(nms_ply$geometry) %>% st_coordinates() %>% as_tibble() %>% 
    tail(1) %>% 
    mutate(id = !!nms) %>% 
    select(id, lon = X, lat = Y) %>% 
    write_csv(sites_csv)
}

site <- read_csv(sites_csv) %>%
  filter(id == nms)

sst   <- info('jplMURSST41mday')
chl   <- info("nesdisVHNSQchlaMonthly")
scape <- info("noaa_aoml_4729_9ee6_ab54", url = "https://cwcgom.aoml.noaa.gov/erddap/")
```
```{r modal_info}
get_modal_info()
```

## Maps {.tabset}

### Temperature

```{r}
# get most recent date
date_end <- get_dates(sst)[2]

leaflet(
  nms_ply,
  options = leafletOptions(
    crs = leafletCRS(crsClass = "L.CRS.EPSG4326"))) %>%
  # basemap from GBIF in 4326
  addTiles("//tile.gbif.org/4326/omt/{z}/{x}/{y}@1x.png?style=gbif-geyser") %>%
  # sst
  addWMSTiles(
    baseUrl = 'https://coastwatch.pfeg.noaa.gov/erddap/wms/jplMURSST41mday/request?',
    layers = "jplMURSST41mday:sst",
    options = WMSTileOptions(
      version = "1.3.0", format = "image/png", transparent = T, opacity = 0.7,
      time = format(date_end,"%Y-%m-%dT00:00:00Z")))  %>%
  addPolygons() %>% 
  addMarkers(lng = ~lon, lat = ~lat, label = ~id, data=site) %>%
  addMouseCoordinates() %>%
  addLegend(
    position="bottomright",
    title = paste0("SST (°C)<br>", format(date_end,"%Y-%m-%d")),
    colorNumeric("Spectral", c(0,32), reverse=T), seq(0,32))
```

`r md_caption("Figure Ux.Ocean.SST.ERD.map.")`

`r md_caption("Figure Ux.Ocean.SST.ERD.map.", get_details = T)`

### Chlorophyll

```{r}
# get most recent date
d_2 <- get_dates(chl)[2]

leaflet(
  nms_ply,
  options = leafletOptions(
    crs = leafletCRS(crsClass = "L.CRS.EPSG4326"))) %>%
  # basemap from GBIF in 4326
  addTiles("//tile.gbif.org/4326/omt/{z}/{x}/{y}@1x.png?style=gbif-geyser") %>%
  # sst
  addWMSTiles(
    baseUrl = 'https://coastwatch.pfeg.noaa.gov/erddap/wms/nesdisVHNSQchlaMonthly/request?',
    layers = "nesdisVHNSQchlaMonthly:chlor_a",
    options = WMSTileOptions(
      version = "1.3.0", format = "image/png", transparent = T, opacity = 0.7,
      time = format(d_2,"%Y-%m-%dT00:00:00Z")))  %>%
  addPolygons() %>% 
  addMarkers(lng = ~lon, lat = ~lat, label = ~id, data=site) %>%
  addMouseCoordinates() %>%
  addLegend(
    position="bottomright",
    title = paste0("CHL (mg m^-3)<br>", format(d_2,"%Y-%m-%d")),
    colorNumeric("Spectral", c(0,4), reverse=T), seq(0,4))
```

`r md_caption("Figure Ux.Ocean.Chl.ERD.map.")`

`r md_caption("Figure Ux.Ocean.Chl.ERD.map.", get_details = T)`

### Seascape

```{r}
# get most recent date
d_2 <- get_dates(scape)[2]

leaflet(
  nms_ply,
  options = leafletOptions(
    crs = leafletCRS(crsClass = "L.CRS.EPSG4326"))) %>%
  # basemap from GBIF in 4326
  addTiles("//tile.gbif.org/4326/omt/{z}/{x}/{y}@1x.png?style=gbif-geyser") %>%
  # sst
  addWMSTiles(
    baseUrl = 'https://cwcgom.aoml.noaa.gov/erddap/wms/noaa_aoml_4729_9ee6_ab54/request?',
    layers = "noaa_aoml_4729_9ee6_ab54:CLASS",
    options = WMSTileOptions(
      version = "1.3.0", format = "image/png", transparent = T, opacity = 0.7,
      time = format(d_2,"%Y-%m-%dT00:00:00Z")))  %>%
  addPolygons() %>% 
  addMarkers(lng = ~lon, lat = ~lat, label = ~id, data=site) %>%
  addMouseCoordinates() %>%
  addLegend(
    position="bottomright",
    title = paste0("CLASS<br>", format(d_2,"%Y-%m-%d")),
    colorNumeric("Spectral", c(1,33), reverse=T), seq(1,33))
```

`r md_caption("Figure Ux.Ocean.Seascape.ERD.map.")`

`r md_caption("Figure Ux.Ocean.Seascape.ERD.map.", get_details = T)`

## Trends {.tabset}

##### Acidification

##### Aragonite saturation

![`r md_caption("Figure App.E.10.29.")`](../img/cinms_cr/App.E.10.29.jpg)

`r md_caption("Figure App.E.10.29.", get_details=T)`



###### Domoic Acid

![`r md_caption("Figure App.D.7.1.")`](../img/cinms_cr/App.D.7.1_DA levels in crustaceans and bivalves in 2012 and 2013_C. Culver CA Sea Grant copy.jpg)

`r md_caption("Figure App.D.7.1.", get_details=T)`

###### Harmful Algal Bloom (May 2015)

![`r md_caption("Figure App.D.7.3.")`](../img/cinms_cr/App.D.7.3_2015 HAB_McCabe et al. 2016.jpg)

`r md_caption("Figure App.D.7.3.", get_details=T)`


## Timeseries {.tabset}

### Temperature

```{r}
csv  <- here(glue("data/oceano/sst_{nms}.csv"))
url  <- glue("https://github.com/marinebon/{nms}/raw/master/data/oceano/{basename(csv)}")
html <- a(basename(csv), href=url, target='_blank')

d   <- get_timeseries(sst, lon=site$lon, lat=site$lat, csv=csv, field="sst")
plot_timeseries(d, title="SST", color="red")
```

`r md_caption("Figure Ux.Ocean.SST.ERD.timeseries.")`

`r md_caption("Figure Ux.Ocean.SST.ERD.timeseries.", get_details = T)`

Download timeseries data for sanctuary: `r html`

### Chlorophyll

```{r}
csv  <- here(glue("data/oceano/chl_{nms}.csv"))
url  <- glue("https://github.com/marinebon/{nms}/raw/master/data/oceano/{basename(csv)}")
html <- a(basename(csv), href=url, target='_blank')

d_2   <- get_timeseries(chl, lon=site$lon, lat=site$lat, csv=csv, field="chlor_a")
plot_timeseries(d_2, title="CHL", color="green")
```

`r md_caption("Figure Ux.Ocean.Chl.ERD.timeseries.")`

`r md_caption("Figure Ux.Ocean.Chl.ERD.timeseries.", get_details = T)`

Download timeseries data for sanctuary: `r html`

### Temp & N Anomalies (7-10m)

![**Figure App.D.6.7.** Monthly anomalies in (top panel) observed bottom temperature (°C) at 7–10 meters depth and (bottom panel) modeled bottom nitrate concentrations (μmol/L) at 7–10 meters depth along the Santa Barbara Channel mainland nearshore (nine sampling sites roughly spanning from Gaviota east to Ventura). The anomalously warm years of 2014–2015 are shown in red. Similar trends were seen at the islands. Figure: Reed et al. 2016/Santa Barbara Coastal Long-term Ecological Research
](../img/cinms_cr/App.D.6.7_SST and nitrate anomalies 2001-2015_Reed et al._2016.jpg)
