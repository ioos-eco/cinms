---
output: html_document
editor_options: 
  chunk_output_type: console
---
```{r setup, include=F}
knitr::opts_chunk$set(echo = F, message = F, warning = F)
```

```{r}
source(here::here("scripts/oceano.R"))

nms       <- "cinms"
sites_csv <- here("data/nms_sites.csv")

nms_ply <- get_nms_ply(nms)

if (F){
  st_centroid(nms_ply$geometry) %>% st_coordinates() %>% as_tibble() %>% 
    tail(1) %>% 
    mutate(id = !!nms) %>% 
    select(id, lon = X, lat = Y) %>% 
    write_csv(sites_csv)
}

site <- read_csv(sites_csv) %>%
  filter(id == nms)

sst   <- info('jplMURSST41mday')
chl   <- info("nesdisVHNSQchlaMonthly")
scape <- info("noaa_aoml_4729_9ee6_ab54", url = "https://cwcgom.aoml.noaa.gov/erddap/")
```
```{r modal_info}
get_modal_info()
```

## Maps {.tabset}

### Temperature

```{r}
# get most recent date
date_end <- get_dates(sst)[2]
```

Map of the most recent (`r format(date_end,"%Y-%m-%d")`) sea-surface temperature around the site. Data source: PFEG CoastWatch via ERDDAP.

```{r}
leaflet(
  nms_ply,
  options = leafletOptions(
    crs = leafletCRS(crsClass = "L.CRS.EPSG4326"))) %>%
  # basemap from GBIF in 4326
  addTiles("//tile.gbif.org/4326/omt/{z}/{x}/{y}@1x.png?style=gbif-geyser") %>%
  # sst
  addWMSTiles(
    baseUrl = 'https://coastwatch.pfeg.noaa.gov/erddap/wms/jplMURSST41mday/request?',
    layers = "jplMURSST41mday:sst",
    options = WMSTileOptions(
      version = "1.3.0", format = "image/png", transparent = T, opacity = 0.7,
      time = format(date_end,"%Y-%m-%dT00:00:00Z")))  %>%
  addPolygons() %>% 
  addMarkers(lng = ~lon, lat = ~lat, label = ~id, data=site) %>%
  addMouseCoordinates() %>%
  addLegend(
    position="bottomright",
    title = paste0("SST (°C)<br>", format(date_end,"%Y-%m-%d")),
    colorNumeric("Spectral", c(0,32), reverse=T), seq(0,32))
```

### Chlorophyll

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# get most recent date
d_2 <- get_dates(chl)[2]
```

Map of the most recent (`r format(d_2, "%Y-%m-%d")`) Chlorophyll-a around the site. Data Source: PFEG CoastWatch via ERDDAP.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
leaflet(
  nms_ply,
  options = leafletOptions(
    crs = leafletCRS(crsClass = "L.CRS.EPSG4326"))) %>%
  # basemap from GBIF in 4326
  addTiles("//tile.gbif.org/4326/omt/{z}/{x}/{y}@1x.png?style=gbif-geyser") %>%
  # sst
  addWMSTiles(
    baseUrl = 'https://coastwatch.pfeg.noaa.gov/erddap/wms/nesdisVHNSQchlaMonthly/request?',
    layers = "nesdisVHNSQchlaMonthly:chlor_a",
    options = WMSTileOptions(
      version = "1.3.0", format = "image/png", transparent = T, opacity = 0.7,
      time = format(d_2,"%Y-%m-%dT00:00:00Z")))  %>%
  addPolygons() %>% 
  addMarkers(lng = ~lon, lat = ~lat, label = ~id, data=site) %>%
  addMouseCoordinates() %>%
  addLegend(
    position="bottomright",
    title = paste0("CHL (mg m^-3)<br>", format(d_2,"%Y-%m-%d")),
    colorNumeric("Spectral", c(0,4), reverse=T), seq(0,4))
```

### Seascape

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# get most recent date
d_2 <- get_dates(scape)[2]
```

Map of the most recent (`r format(d_2, "%Y-%m-%d")`) seascapes around the site. Data Source: AOML CWCGOM via ERDDAP.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
leaflet(
  nms_ply,
  options = leafletOptions(
    crs = leafletCRS(crsClass = "L.CRS.EPSG4326"))) %>%
  # basemap from GBIF in 4326
  addTiles("//tile.gbif.org/4326/omt/{z}/{x}/{y}@1x.png?style=gbif-geyser") %>%
  # sst
  addWMSTiles(
    baseUrl = 'https://cwcgom.aoml.noaa.gov/erddap/wms/noaa_aoml_4729_9ee6_ab54/request?',
    layers = "noaa_aoml_4729_9ee6_ab54:CLASS",
    options = WMSTileOptions(
      version = "1.3.0", format = "image/png", transparent = T, opacity = 0.7,
      time = format(d_2,"%Y-%m-%dT00:00:00Z")))  %>%
  addPolygons() %>% 
  addMarkers(lng = ~lon, lat = ~lat, label = ~id, data=site) %>%
  addMouseCoordinates() %>%
  addLegend(
    position="bottomright",
    title = paste0("CLASS<br>", format(d_2,"%Y-%m-%d")),
    colorNumeric("Spectral", c(1,33), reverse=T), seq(1,33))
```

Read more about seascapes [here](http://www.marinebon.org/seascapes.html). 


## Trends {.tabset}

##### Acidification

##### Aragonite saturation

![`r md_caption("Figure App.E.10.29.")`](../img/cinms_cr/App.E.10.29.jpg)

`r md_caption("Figure App.E.10.29.", get_details=T)`



###### Domoic Acid

![`r md_caption("Figure App.D.7.1.")`](../img/cinms_cr/App.D.7.1_DA levels in crustaceans and bivalves in 2012 and 2013_C. Culver CA Sea Grant copy.jpg)

`r md_caption("Figure App.D.7.1.", get_details=T)`

###### Harmful Algal Bloom (May 2015)

![`r md_caption("Figure App.D.7.3.")`](../img/cinms_cr/App.D.7.3_2015 HAB_McCabe et al. 2016.jpg)

`r md_caption("Figure App.D.7.3.", get_details=T)`


## Timeseries {.tabset}

### Temperature

```{r, echo=FALSE, message=FALSE, warning=FALSE}
csv <- here(glue("data/oceano/sst_{nms}.csv"))
d   <- get_timeseries(sst, lon=site$lon, lat=site$lat, csv=csv, field="sst")
plot_timeseries(d, title="SST", color="red")
```

Download data: [`r basename(csv)`](https://raw.githubusercontent.com/marinebon/`r nms`/master/data/oceano/`r basename(csv)`)

### Chlorophyll

```{r, echo=FALSE, message=FALSE, warning=FALSE}
csv <- here(glue("data/oceano/chl_{nms}.csv"))
d_2   <- get_timeseries(chl, lon=site$lon, lat=site$lat, csv=csv, field="chlor_a")
plot_timeseries(d_2, title="CHL", color="green")
```

Download data: [`r basename(csv)`](https://raw.githubusercontent.com/marinebon/`r nms`/master/data/oceano/`r basename(csv))

### Temp & N Anomalies (7-10m)

![**Figure App.D.6.7.** Monthly anomalies in (top panel) observed bottom temperature (°C) at 7–10 meters depth and (bottom panel) modeled bottom nitrate concentrations (μmol/L) at 7–10 meters depth along the Santa Barbara Channel mainland nearshore (nine sampling sites roughly spanning from Gaviota east to Ventura). The anomalously warm years of 2014–2015 are shown in red. Similar trends were seen at the islands. Figure: Reed et al. 2016/Santa Barbara Coastal Long-term Ecological Research
](../img/cinms_cr/App.D.6.7_SST and nitrate anomalies 2001-2015_Reed et al._2016.jpg)
