---
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r, include=F}
knitr::opts_chunk$set(echo=F, message=F, warning=F, error=F)

library(glue)
source(here::here("scripts/calcofi.R"))
```

## {.tabset}

### Map of Regions

```{r}
md_caption <- function(title = NULL, md = here::here("modals/_captions.md")){
  #title = "Figure App.F.12.17.new"
  #md_caption("Figure App.F.12.17.new")
  
  library(dplyr)
  library(tidyr)
  library(stringr)
  
  stopifnot(file.exists(md))
  
  caption <- tibble(
    # read lines of markdown in _captions.md
    ln = readLines(md) %>% str_trim()) %>%
    # detect header with title, set rest to NA
    mutate(
      hdr = str_detect(ln, glue("^## {title}")) %>% na_if(FALSE)) %>% 
    # fill down so capturing all starting with title header
    fill(hdr) %>% 
    # filter for title header down, removing previous lines
    filter(hdr) %>% 
    # remove title header
    slice(-1) %>% 
    # detect subsequent headers
    mutate(
      hdr = str_detect(ln, "^##") %>% na_if(F)) %>% 
    # fill down
    fill(hdr) %>%
    mutate(
      hdr = replace_na(hdr, FALSE)) %>% 
    # filter for not header down, removing subsequent lines outside caption
    filter(!hdr) %>% 
    # extract lines and collapse
    pull(ln) %>% paste0(collapse = "\n") %>% 
    # trim space and newlines
    str_trim()
  
  # prepend with title
  glue("**{title}**. {caption}")
}
```

```{r, fig.cap=md_caption("Figure App.F.12.17.new")}
calcofi_map()
```

### Larval fish, cool-water associated ichthyoplankton {.active}

#### CINMS Region

```{r}
grp   <- "Cool-water associated ichthyoplankton"
rgn   <- "CINMS"

title <- glue("{grp} - {rgn} Region")
csv   <- glue("https://raw.githubusercontent.com/marinebon/calcofi-analysis/master/data/{grp}_{rgn}.csv")

calcofi_plot(csv = csv, title = title)
```

#### SoCal Shelf Region

```{r}
grp   <- "Cool-water associated ichthyoplankton"
rgn   <- "SoCal Shelf"

title <- glue("{grp} - {rgn} Region")
csv   <- glue("https://raw.githubusercontent.com/marinebon/calcofi-analysis/master/data/{grp}_{rgn}.csv")

#download.file(csv, "_tmp.csv")
calcofi_plot(csv = csv, title = title)
```




### Larval fish, warm-water associated ichthyoplankton (larval fish)

#### CINMS Region

```{r}
grp   <- "Warm-water associated ichthyoplankton"
rgn   <- "CINMS"

title <- glue("{grp} - {rgn} Region")
csv   <- glue("https://raw.githubusercontent.com/marinebon/calcofi-analysis/master/data/{grp}_{rgn}.csv")

calcofi_plot(csv = csv, title = title)
```

#### SoCal Shelf Region

```{r}
grp   <- "Warm-water associated ichthyoplankton"
rgn   <- "SoCal Shelf"

title <- glue("{grp} - {rgn} Region")
csv   <- glue("https://raw.githubusercontent.com/marinebon/calcofi-analysis/master/data/{grp}_{rgn}.csv")

#download.file(csv, "_tmp.csv")
calcofi_plot(csv = csv, title = title)
```






### Larval fish - Mean Species Richness

#### CINMS Region

![](../img/cinms_cr/App.F.15.6.a.CalCOFI_diversity_richness-cinms.jpg)

#### SoCal Shelf Region

![`r md_caption("Figure App.F.15.6.a-b")`](../img/cinms_cr/App.F.15.6.b.CalCOFI_diversity_richness-socal.jpg)


### Larval fish - Mean Simpson Diversity

#### CINMS Region

![`r md_caption("Figure App.F.15.6.c-d")`](../img/cinms_cr/App.F.15.6.c.CalCOFI_diversity_diversity-cinms.jpg)

#### SoCal Shelf Region

![](../img/cinms_cr/App.F.15.6.d.CalCOFI_diversity_diversity-socal.jpg)
